SUPPORTED_LUAS = 5.4 5.3 5.2 5.1

LUAROCKS := luarocks --tree lua_modules --lua-version $(LUA_VERSION)

if !SYSTEM_LUAROCKS
nobase_nodist_pkgdata_DATA = $(LUAMODULES)
LUAMODLOCK := sile-dev-1.rockslock
LUAMODSPEC := sile-dev-1.rockspec
genrockslock := $(LUAROCKS) $(LUAROCKSARGS) list --porcelain | awk '{print $$1 " " $$2}'
rocksmatch := cmp -s $(LUAMODLOCK) <($(genrockslock))
endif

.PHONY: installrocks disallow-dist-with-system-luarocks
if !SYSTEM_LUAROCKS
installrocks: $(LUAMODLOCK) $(shell $(rocksmatch) || echo lua_modules)

lua_modules: $(LUAMODSPEC) $(shell $(rocksmatch) || echo force)
	if test -e .git; then
		$(LUAROCKS) $(LUAROCKSARGS) install --only-deps $<
	else
		rm -rf lua_modules
		cp -a lua_modules_dist lua_modules
		for luaver in $(filter-out $(LUA_VERSION),$(SUPPORTED_LUAS)); do
			find lua_modules -maxdepth 3 -type d -name "*$$luaver" -execdir rm -rf {} \;
		done
	fi

$(LUAMODLOCK): lua_modules $(LUAMODSPEC)
	$(genrockslock) > $@

sile: installrocks

disallow-dist-with-system-luarocks: ;
else
disallow-dist-with-system-luarocks:
	$(error In order to make dist you must configure --without-system-luarocks)
	exit 1
endif

.PHONY: lua_modules_dist
lua_modules_dist: $(foreach LUA,$(SUPPORTED_LUAS),lua_modules_dist_$(LUA))

.PHONY: lua_modules_dist_%
lua_modules_dist_%: LUAROCKS = luarocks --tree lua_modules_dist --lua-version $*
lua_modules_dist_%: $(LUAMODSPEC) disallow-dist-with-system-luarocks
	$(LUAROCKS) $(LUAROCKSARGS) install --only-deps $<
