.PHONY: installrocks
if !SYSTEM_LUAROCKS
_INSTALLROCKS = installrocks
LUAROCKS := luarocks --tree lua_modules --lua-version $(LUA_VERSION)

LUAMODLOCK := sile-dev-1.rockslock
LUAMODSPEC := sile-dev-1.rockspec
genrockslock := $(LUAROCKS) $(LUAROCKSARGS) list --porcelain | awk '{print $$1 " " $$2}'
rocksmatch := cmp -s $(LUAMODLOCK) <($(genrockslock))

installrocks: $(LUAMODLOCK) $(shell $(rocksmatch) || echo lua_modules)

lua_modules: $(LUAMODSPEC) $(shell $(rocksmatch) || echo force)
	$(LUAROCKS) $(LUAROCKSARGS) install --only-deps $<

$(LUAMODLOCK): lua_modules $(LUAMODSPEC)
	$(genrockslock) > $@

sile: installrocks
endif
