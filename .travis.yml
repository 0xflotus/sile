language: c
sudo: false
compiler:
 - gcc
addons:
 apt:
  packages:
   - libgraphite2-dev
   - libicu-dev
   - libreadline-dev
   - libfreetype6-dev
   - libfontconfig1-dev
   - libpng-dev
   - libexpat1-dev
   - lua5.2
   - liblua5.2-dev
   - lua-filesystem
   - luarocks
env:
  global:
   - LUAROCKS_BASE=luarocks-2.2.2
   - HARFBUZZ_BASE=harfbuzz-1.0.4
   - GRAPHITE=true
  matrix:
   - LUA_VER=5.2
   - LUA_VER=5.2 GRAPHITE=false
before_install:
 - mkdir ~/local/
 - export LD_LIBRARY_PATH=$(HOME)/local/lib:$LD_LIBRARY_PATH
 - export PKG_CONFIG_PATH=$(HOME)/local/lib/pkgconfig:$PKG_CONFIG_PATH
 - export LUA_PKG=lua$LUA_VER LUA_DEV=liblua$LUA_VER-dev LUA_SFX=$LUA_VER
 - export LUA_INCDIR=/usr/include/lua$LUA_VER;
 - mkdir ~/.fonts && pushd ~/.fonts/ && wget http://dealer.simon-cozens.org/~simon/tmp/silefonts.tar.gz && tar xvf silefonts.tar.gz && popd
 - mkdir ~/builddeps/ && pushd ~/builddeps/ && wget http://www.freedesktop.org/software/harfbuzz/release/$HARFBUZZ_BASE.tar.bz2
 - tar xfj $HARFBUZZ_BASE.tar.bz2 && cd $HARFBUZZ_BASE
 - ./configure --with-graphite2=auto --prefix=$(HOME)/local/ && make && make install && popd
   # Install SILE runtime dependencies
 - luarocks install lpeg
 - luarocks install luaexpat
 - luarocks install lua_cliargs 2.3-3
 - luarocks install busted
script:
 - ./bootstrap.sh && ./configure && make
 - busted -m './lua-libraries/?.lua;./lua-libraries/?/init.lua' tests
 - ./tests/attack.pl
 - ./tests/attack.pl --regression
